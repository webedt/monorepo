version: '3.8'

services:
  internal-api-server:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      PORT: 3000
      NODE_ENV: production

      # Database (external PostgreSQL)
      DATABASE_URL: ${DATABASE_URL}

      # MinIO configuration (uses shared minio from storage-worker stack)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET:-sessions}

      # Session configuration
      SESSION_SECRET: ${SESSION_SECRET}

      # AI Worker
      AI_WORKER_TIMEOUT_MS: ${AI_WORKER_TIMEOUT_MS:-600000}
      AI_WORKER_PORT: ${AI_WORKER_PORT:-5000}

      # Worker Coordinator (replaces DNSRR with direct routing)
      USE_WORKER_COORDINATOR: ${USE_WORKER_COORDINATOR:-true}
      DOCKER_SOCKET_PATH: ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}
      WORKER_SWARM_SERVICE_NAME: ${WORKER_SWARM_SERVICE_NAME:-webedt-app-ai-coding-workers-gy4wew_ai-coding-worker}
      WORKER_COORDINATOR_REFRESH_INTERVAL_MS: ${WORKER_COORDINATOR_REFRESH_INTERVAL_MS:-5000}
      WORKER_STALE_BUSY_TIMEOUT_MS: ${WORKER_STALE_BUSY_TIMEOUT_MS:-600000}
      WORKER_NO_CAPACITY_RETRY_MS: ${WORKER_NO_CAPACITY_RETRY_MS:-1000}
      WORKER_NO_CAPACITY_MAX_RETRIES: ${WORKER_NO_CAPACITY_MAX_RETRIES:-10}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}

      # GitHub OAuth
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}

      # OpenAI (for transcription)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

    # Mount Docker socket for Worker Coordinator
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - dokploy-network
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

networks:
  dokploy-network:
    external: true
