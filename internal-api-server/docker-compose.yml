version: '3.8'

services:
  internal-api-server:
    image: dockerregistry.etdofresh.com/internal-api-server:latest
    environment:
      PORT: 3000
      NODE_ENV: production

      # Database (external PostgreSQL)
      DATABASE_URL: ${DATABASE_URL}

      # MinIO configuration (uses shared minio from storage-worker stack)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET:-sessions}

      # Session configuration
      SESSION_SECRET: ${SESSION_SECRET}

      # AI Worker
      AI_WORKER_URL: ${AI_WORKER_URL:-http://ai-coding-worker:5000}
      AI_WORKER_TIMEOUT_MS: ${AI_WORKER_TIMEOUT_MS:-600000}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}

      # GitHub OAuth
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}

      # OpenAI (for transcription)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

    networks:
      - dokploy-network
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

networks:
  dokploy-network:
    external: true
