# Preview URL - Branch Name Sanitization

## Update Summary

The preview URL helper now automatically sanitizes branch names by replacing forward slashes (`/`) with dashes (`-`) when generating URLs. This ensures URL safety and proper routing for branch names that contain slashes.

## Why This Change?

Git branch names often contain forward slashes for organization, such as:
- `feature/new-feature`
- `bugfix/issue-123`
- `release/v1.0.0`

However, forward slashes in URLs can cause routing issues and confusion with path separators. By replacing them with dashes, we get clean, safe URLs.

## Examples

### Before
```
Branch: feature/new-feature
URL: https://github.etdofresh.com/owner/repo/feature/new-feature/
     ❌ Ambiguous - looks like nested paths
```

### After
```
Branch: feature/new-feature
URL: https://github.etdofresh.com/owner/repo/feature-new-feature/
     ✅ Clear and unambiguous
```

## Implementation

### Code Changes

Both helper files now include branch sanitization:

**ai-coding-worker/src/utils/previewUrlHelper.ts:**
```typescript
// Use default preview URL
// Replace forward slashes in branch name with dashes for URL safety
const safeBranch = branch.replace(/\//g, '-');
const defaultUrl = `https://github.etdofresh.com/${owner}/${repo}/${safeBranch}/`;
```

**website/apps/server/src/utils/previewUrlHelper.ts:**
```typescript
// Use default preview URL
// Replace forward slashes in branch name with dashes for URL safety
const safeBranch = branch.replace(/\//g, '-');
const defaultUrl = `https://github.etdofresh.com/${owner}/${repo}/${safeBranch}/`;
```

### Transformation Examples

| Original Branch | Sanitized Branch | Preview URL |
|----------------|------------------|-------------|
| `main` | `main` | `https://github.etdofresh.com/owner/repo/main/` |
| `develop` | `develop` | `https://github.etdofresh.com/owner/repo/develop/` |
| `feature/login` | `feature-login` | `https://github.etdofresh.com/owner/repo/feature-login/` |
| `bugfix/issue-42` | `bugfix-issue-42` | `https://github.etdofresh.com/owner/repo/bugfix-issue-42/` |
| `release/v2.0.0` | `release-v2.0.0` | `https://github.etdofresh.com/owner/repo/release-v2.0.0/` |
| `user/john/experiment` | `user-john-experiment` | `https://github.etdofresh.com/owner/john/user-john-experiment/` |

## Behavior

### Applied To
- ✅ Default preview URLs generated by the helper
- ✅ Error fallback URLs
- ✅ All branch names, regardless of format

### NOT Applied To
- ❌ Custom preview URLs from `.webedt` file (user controls these)
- ❌ Repository owner or name (only branch names)

## Usage

No changes needed in code using the helper:

```typescript
// This automatically sanitizes the branch name
const url = await getPreviewUrl(
  '/workspace',
  'myorg',
  'myrepo',
  'feature/new-ui'  // Contains slash
);

console.log(url);
// Output: https://github.etdofresh.com/myorg/myrepo/feature-new-ui/
//                                                     ^^^^^^^^^^^^^^
//                                                     Slash replaced with dash
```

## Logging

The AI worker version includes both original and sanitized branch names in logs:

```typescript
logger.info('Using default preview URL', {
  component: 'PreviewUrlHelper',
  previewUrl: defaultUrl,
  owner,
  repo,
  branch,        // Original: "feature/new-ui"
  safeBranch    // Sanitized: "feature-new-ui"
});
```

## Edge Cases

### Multiple Consecutive Slashes
```
Branch: feature//test
Sanitized: feature--test
URL: https://github.etdofresh.com/owner/repo/feature--test/
```

### Leading/Trailing Slashes
```
Branch: /feature/
Sanitized: -feature-
URL: https://github.etdofresh.com/owner/repo/-feature-/
```

### Only Slashes
```
Branch: ///
Sanitized: ---
URL: https://github.etdofresh.com/owner/repo/---/
```

Note: These edge cases are theoretical - Git branch naming conventions prevent most of these scenarios.

## Files Modified

1. ✅ `ai-coding-worker/src/utils/previewUrlHelper.ts`
   - Added `safeBranch` transformation in default URL generation
   - Added `safeBranch` transformation in error fallback
   - Added `safeBranch` to logging output

2. ✅ `website/apps/server/src/utils/previewUrlHelper.ts`
   - Added `safeBranch` transformation in default URL generation
   - Added `safeBranch` transformation in error fallback

## Testing

### Manual Test

```bash
# Create a branch with slash
git checkout -b feature/test-preview

# Start a session
# Navigate to Preview tab
# Check URL in browser address bar or new tab
# Should see: https://github.etdofresh.com/owner/repo/feature-test-preview/
```

### Automated Test

```typescript
describe('Preview URL Helper', () => {
  it('should sanitize branch names with slashes', async () => {
    const url = await getPreviewUrl(
      '/workspace',
      'owner',
      'repo',
      'feature/new-feature'
    );

    expect(url).toBe('https://github.etdofresh.com/owner/repo/feature-new-feature/');
  });

  it('should handle branches without slashes', async () => {
    const url = await getPreviewUrl(
      '/workspace',
      'owner',
      'repo',
      'main'
    );

    expect(url).toBe('https://github.etdofresh.com/owner/repo/main/');
  });
});
```

## Benefits

✅ **URL Safety** - No ambiguous paths in URLs
✅ **Routing Clarity** - Clear separation between path segments
✅ **Consistency** - All branch names treated uniformly
✅ **Backward Compatible** - Doesn't break existing branch names without slashes
✅ **Simple** - Single regex replacement, easy to understand
✅ **Reliable** - Works for all possible slash combinations

## Notes

- The transformation is **one-way** (not reversible from URL back to branch)
- Server-side routing should handle the sanitized branch names
- Custom `.webedt` URLs are not modified (user controls these completely)
- The original branch name is preserved in the database and Git

---

**Status**: ✅ Complete and deployed
**Last Updated**: 2024-11-27
**Version**: 1.1
