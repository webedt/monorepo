version: '3.8'

services:
  webedt:
    build:
      context: ..
      dockerfile: services/Dockerfile
      args:
        BUILD_COMMIT_SHA: ${BUILD_COMMIT_SHA:-unknown}
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-unknown}
        BUILD_IMAGE_TAG: ${BUILD_IMAGE_TAG:-latest}
        BUILD_VERSION: ${BUILD_VERSION:-0.0.0}
    container_name: webedt-services
    ports:
      - "3000:3000"
    environment:
      # Server configuration
      NODE_ENV: ${NODE_ENV:-production}
      WEBSITE_PORT: 3000
      API_PORT: 3001

      # Worker configuration
      WORKER_POOL_MODE: local
      WORKER_POOL_SIZE: ${WORKER_POOL_SIZE:-2}
      WORKER_BASE_PORT: 5001
      WORKSPACE_DIR: /workspace

      # Database
      DATABASE_URL: ${DATABASE_URL}

      # MinIO Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET:-sessions}

      # Authentication
      SESSION_SECRET: ${SESSION_SECRET}

      # GitHub OAuth
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://webedt.etdofresh.com}

      # Claude Remote Sessions (optional)
      CLAUDE_ENVIRONMENT_ID: ${CLAUDE_ENVIRONMENT_ID:-}
      CLAUDE_API_BASE_URL: ${CLAUDE_API_BASE_URL:-https://api.anthropic.com}
      CLAUDE_DEFAULT_MODEL: ${CLAUDE_DEFAULT_MODEL:-claude-opus-4-5-20251101}
      CLAUDE_ORG_UUID: ${CLAUDE_ORG_UUID:-}
      CLAUDE_COOKIES: ${CLAUDE_COOKIES:-}

      # OpenRouter (optional)
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}

      # Build info
      BUILD_COMMIT_SHA: ${BUILD_COMMIT_SHA:-unknown}
      BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-unknown}
      BUILD_IMAGE_TAG: ${BUILD_IMAGE_TAG:-latest}
    volumes:
      - workspace-data:/workspace
    networks:
      - webedt-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  workspace-data:

networks:
  webedt-network:
    driver: bridge
